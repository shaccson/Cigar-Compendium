<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${user.username} + '\'s profile · Cigar Compendium'">Profile</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .two-col{display:grid;grid-template-columns:1.5fr 1fr;gap:18px}
        @media (max-width:900px){.two-col{grid-template-columns:1fr}}
        .section{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px}
        .section h3{margin:0 0 10px}
        .muted-small{color:var(--muted);font-size:13px}
        .danger{border-color:#7a3b35}
        .danger .btn-primary{background:#7a3b35;border-color:#7a3b35;color:#fff}
        .chips{display:flex;gap:8px;flex-wrap:wrap}
        .chip{background:var(--badge);color:var(--muted);padding:4px 10px;border-radius:999px;font-size:12px}
        .alert.global{margin-top:12px}
        .review-row{display:flex; gap:12px; align-items:flex-start;}
        .review-left{display:flex; gap:12px; align-items:flex-start;}
        .btn-danger{background:#7a3b35; border:1px solid #7a3b35; color:#fff;}
        .btn-danger:hover{filter:brightness(1.08);}
    </style>
</head>
<body>
<div th:replace="~{layout :: layout(~{::content})}">
    <div th:fragment="content">

        <div class="page-header">
            <h2 th:text="${user.username} + '\'s profile'">Profile</h2>
            <a class="btn" th:href="@{/cigars}">← Back to list</a>
        </div>

        <div th:if="${success}" class="alert success global" th:text="${success}"></div>
        <div th:if="${error}" class="alert global" th:text="${error}"></div>

        <div class="two-col">

            <!-- LEFT: activity -->
            <div class="section">
                <h3>Overview</h3>
                <p class="muted">Email: <span th:text="${user.email}"></span></p>

                <div class="chips" style="margin-top:8px">
                    <span class="chip" th:text="'Reviews: ' + ${#lists.size(userReviews)}">Reviews: 0</span>
                    <!-- show role of user only to admins -->
                    <span class="chip" sec:authorize="hasRole('ADMIN')" th:text="${user.role}">ROLE_USER</span>
                </div>

                <h3 style="margin-top:18px">Reviews</h3>

                <div class="list" th:if="${!#lists.isEmpty(userReviews)}">
                    <div class="list-item" th:each="r : ${userReviews}">
                        <div class="review-row">
                            <div class="review-left">
                                <div class="stars">
                                    <span th:each="i : ${#numbers.sequence(1,5)}"
                                          th:classappend="${i <= r.rating} ? 'star filled' : 'star'">★</span>
                                </div>
                                <div>
                                    <a th:href="@{'/cigar/' + ${r.cigar.id}}" th:text="${r.cigar.name}">Cigar</a>
                                    <div class="muted" th:if="${r.comment}" th:text="${r.comment}"></div>
                                </div>
                            </div>

                            <!-- admin can delete -->
                            <form th:action="@{'/reviews/' + ${r.id} + '/delete'}" method="post"
                                  sec:authorize="hasRole('ADMIN')" style="margin:0;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="btn btn-danger" type="submit" title="Delete review">Delete</button>
                            </form>

                            <!-- owner can delete, but only if NOT admin -->
                            <form th:action="@{'/reviews/' + ${r.id} + '/delete'}" method="post"
                                  sec:authorize="isAuthenticated() and !hasRole('ADMIN')"
                                  th:if="${#authentication.name == user.username}"
                                  style="margin:0;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="btn btn-danger" type="submit" title="Delete review">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                <p class="muted" th:if="${#lists.isEmpty(userReviews)}">No reviews yet.</p>
            </div>

            <!-- RIGHT: settings (only on own profile) -->
            <div class="section" th:if="${publicView} == null" style="display:flex; flex-direction:column; gap:16px;">
                <h3>Account settings</h3>

                <!-- change email -->
                <div class="card">
                    <form th:action="@{/profile/email}" th:object="${emailForm}" method="post" class="form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <label>New email
                            <input th:field="*{newEmail}" type="email" placeholder="new@email.com" required>
                            <span class="field-error" th:errors="*{newEmail}"></span>
                        </label>
                        <label>Current password
                            <input th:field="*{currentPassword}" type="password" placeholder="••••••••" required>
                            <span class="field-error" th:errors="*{currentPassword}"></span>
                        </label>
                        <button class="btn btn-primary" type="submit">Update email</button>
                    </form>
                </div>

                <!-- change password -->
                <div class="card">
                    <form th:action="@{/profile/password}" th:object="${passwordForm}" method="post" class="form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <label>New password
                            <input th:field="*{newPassword}" type="password" placeholder="at least 6 characters" required>
                            <span class="field-error" th:errors="*{newPassword}"></span>
                        </label>
                        <label>Current password
                            <input th:field="*{currentPassword}" type="password" placeholder="••••••••" required>
                            <span class="field-error" th:errors="*{currentPassword}"></span>
                        </label>
                        <button class="btn btn-primary" type="submit">Change password</button>
                    </form>
                </div>

                <!-- danger zone (user profile deletion) -->
                <div class="card danger">
                    <h3>Delete account</h3>
                    <p class="muted-small">This action is irreversible. All your reviews will be removed.</p>
                    <form th:action="@{/profile/delete}" th:object="${deleteForm}" method="post" class="form" style="margin-top:8px;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <label>Current password
                            <input th:field="*{currentPassword}" type="password" placeholder="••••••••" required>
                            <span class="field-error" th:errors="*{currentPassword}"></span>
                        </label>
                        <button class="btn btn-primary" type="submit">Delete my account</button>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>
</body>
</html>
